<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Devis Nsigma</title>

    <!-- Bootstrap Core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Theme CSS -->
    <link href="css/freelancer.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body id="page-top" class="index">

    <!-- Navigation -->
    <nav id="mainNav" class="navbar navbar-default navbar-fixed-top navbar-custom">
        <div class="container">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span> Menu <i class="fa fa-bars"></i>
                </button>
                <a class="navbar-brand" href="#page-top">Devis <span class="brand-name">Nsigma</span></a>
            </div>

            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    <li class="page-scroll">
                        <a href="#objectives">Objectifs</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#steps">Phases</a>
                    </li>
                    <li class="page-scroll">
                        <a href="#offer">Offre</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <img class="img-responsive" src="img/profile.png" alt="Logo Nsigma Junior Entreprise">
                    <div class="intro-text">
                        <span class="name">{{ title }}</span>
                        <hr class="line light"></hr>
                        <span class="skills">Devis #{{ version }} - {{ date }}</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Objectives Section -->
    <section class="dark" id="objectives">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Objectifs de l'étude</h2>
                    <hr class="line dark"></hr>
                </div>
            </div>
            <div class="row" id="objectives-description">
                <div class="col-lg-4 col-lg-offset-2">
                    <p>{{ objectives_left }}</p>
                </div>
                <div class="col-lg-4">
                    <p>{{ objectives_right }}</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Steps Section -->
    <section class="dark" id="steps">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Phases</h2>
                    <hr class="line dark"></hr>
                </div>
            </div>
            <div class="row">
            {% for name, step in steps.items() %}
              <h3>{{ name }}</h3>
              <div class="step-description col-lg-12">
                <div class="col-lg-6">
                  <p><strong>Objectifs :</strong> {{ step.objectives }}</p>

                  <p><strong>Prix :</strong> {{ step.price }} &euro;</p>

                  <p><strong>Priorité :</strong> {{ step.priority }}/20</p>
                </div>
                <div class="col-lg-6">
                  <p>
                    <strong>Fonctionnalités :</strong>
                  </p>
                  <div class="col-lg-6">
                    <ul>
                    {% for feature in step.features_left %}
                      <li>{{ feature }}</li>
                    {% endfor %}
                    </ul>
                  </div>
                  <div class="col-lg-6">
                    <ul>
                    {% for feature in step.features_right %}
                      <li>{{ feature }}</li>
                    {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            {% endfor %} 
            </div>
        </div>
    </section>

    <!-- Offers Section -->
    <section class="dark" id="offer">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Offre</h2>
                    <hr class="line dark"></hr>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12 text-center">
                  <table id="offer-table" class="table-bordered">
                    <tr>
                      <th><a href="#" data-toggle="tooltip" title="Cliquer sur une phase l'exclut ou l'intègre au devis.">Phase</a></th>
                      <th>Priorité</th>
                      <th>Montant</th>
                      <th class="empty"></th>
                    </tr>
                    {% for name, step in steps.items() %}
                    <tr>
                      <td data-step="{{ step.slug }}" class="step-name">{{ name }}</td>
                      <td>
                        <select data-step="{{ step.slug }}">
                          {% for i in range(max_prio+1) %}
                            <option value="{{ i }}" {% if i == step.priority %}selected="selected"{% endif %}>{{ i }}</option>
                          {% endfor %}
                        </select>
                      </td>
                      <td class="text-right">{{ step.price }} &euro; H.T.</td>
                      <td class="empty"></td>
                    </tr>
                    {% endfor %}
                    <tr class="empty">
                      <td>_</td>
                      <td></td>
                      <td></td>
                      <td></td>
                    </tr>
                    <tr>
                      <td class="text-right">Sous-total réalisation de l'étude</td>
                      <td>-</td>
                      <td id="steps-price" class="text-right">{{ steps_price }} &euro; H.T.</td>
                      <td class="empty"></td>
                    </tr>
                    <tr>
                      <td class="text-right">Frais de dossier</td>
                      <td>-</td>
                      <td class="text-right">{{ fees }} &euro; H.T.</td>
                      <td class="empty"></td>
                    </tr>
                    <tr>
                      <td class="text-right"><strong>Total hors taxes</strong></td>
                      <td>-</td>
                      <td id="excluding-taxe-price" class="text-right">{{ excluding_taxes_price }} &euro; H.T.</td>
                      <td>
                        <label for="max-price-input"><a href="#" data-toggle="tooltip" title="Fixer une limite de prix sélectionne par ordre de priorité les phases dont la somme des montants est inférieure à cette limite. Ce champ vide, toutes les phases sont incluses.">Max</a> :</label>
                        <input type="text" size="4" id="max-price-input" class="text-right"></input>
                      </td>
                    </tr>
                    <tr class="empty">
                      <td>_</td>
                      <td></td>
                      <td></td>
                      <td></td>
                    </tr>
                    <tr>
                      <td class="text-right">TVA</td>
                      <td>-</td>
                      <td id="vat" class="text-right">{{ vat }} &euro;</td>
                      <td class="empty"></td>
                    </tr>
                    <tr>
                      <td class="text-right"><strong>Total</strong></td>
                      <td>-</td>
                      <td id="total-price" class="text-right">{{ total_price }} &euro; T.T.C.</td>
                      <td class="empty"></td>
                    </tr>
                  </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="text-center">
        <div class="footer-above">
            <div class="container">
                <div class="row">
                    <div class="footer-col col-md-4">
                        <h3>Coordonnées</h3>
                        <p>Nsigma J.E.
                            <br>Grenoble INP - Ensimag
                            <br>681, rue de la Passerelle
                            <br>38402 Saint-Martin-d'Hères</p>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>Retrouvez-nous</h3>
                        <ul class="list-inline">
                            <li>
                                <a href="http://www.nsigma.fr/" class="btn-social btn-outline"><i class="fa fa-fw fa-globe"></i></a>
                            </li>
                            <li>
                                <a href="https://www.facebook.com/nsigma.ensimag" class="btn-social btn-outline"><i class="fa fa-fw fa-facebook"></i></a>
                            </li>
                            <li>
                                <a href="https://twitter.com/JuniorNsigma" class="btn-social btn-outline"><i class="fa fa-fw fa-twitter"></i></a>
                            </li>
                            <li>
                                <a href="https://www.linkedin.com/company/235950" class="btn-social btn-outline"><i class="fa fa-fw fa-linkedin"></i></a>
                            </li>
                        </ul>
                    </div>
                    <div class="footer-col col-md-4">
                        <h3>À propos</h3>
                        <p>Lorem ipsum <strong>dolor sit amet</strong>, consectetur adipiscing <strong>elit</strong>. Fusce molestie magna <strong>at enim</strong> gravida, sed finibus purus condimentum.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer-below">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12">
                      <img src="img/nsigma-small.png" alt="Logo Nsigma Junior Entreprise" />
                        <br>
                        Copyright &copy; Nsigma Junior Entreprise 2017
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="vendor/jquery/jquery.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js"></script>

    <!-- Theme JavaScript -->
    <script src="js/freelancer.min.js"></script>

    <!-- Offer edition -->
    <script>
      $(document).ready(function() {
        var steps = {
          {% for name, step in steps.items() %}
          '{{ step.slug }}': {
            'included': true,
            'price': {{ step.price }},
            'priority': {{ step.priority }},
          },
          {% endfor %}
        };
        var fees = {{ fees }};
        var maxPrice = null;

        function computeStepsPrice() {
          var price = 0;

          $.each(steps, function(name, step) {
            if(step.included) {
              price += step.price;
            }
          });

          return price;
        }

        function changeStepInclusion(cellStep, included) {
          var step = cellStep.data('step');
          steps[step]['included'] = included;
          if(included) {
            cellStep.parent().removeClass('excluded');
          } else {
            cellStep.parent().addClass('excluded');
          }
          updatePrices();
        }

        function updatePrices() {
          var stepsPrice = computeStepsPrice();
          var excludingTaxePrice = stepsPrice + fees;
          var vat = 0.2 * excludingTaxePrice;
          var totalPrice = excludingTaxePrice + vat;

          $('#steps-price').html(stepsPrice + ' &euro; H.T.');
          $('#excluding-taxe-price').html(excludingTaxePrice + ' &euro; H.T.');
          $('#vat').html(vat + ' &euro;');
          $('#total-price').html(totalPrice + ' &euro; T.T.C.');
        }

        function changeStepPriority(step, priority) {
          steps[step].priority = priority;
          updateMaxPrice(maxPrice);
        }

        function includeAllSteps() {
          $.each(steps, function(name, step) {
            changeStepInclusion(getStepCell(name), true);
          });
        }

        function getStepCell(step) {
          return $('#offer-table td[data-step="' + step + '"]');
        }

        function stepsToArray() {
          var array = [];

          $.each(steps, function(name, step) {
            step.name = name;
            array.push(step);
          });

          return array;
        }

        function getStepsOrderedByPrio() {
          var array = stepsToArray();
          array.sort(function(a, b) {
              return b.priority - a.priority; // Sort in descending order
          });
          return array;
        }

        function updateMaxPrice(price) {
          maxPrice = price;
          var remainingPrice = maxPrice - fees;

          if(isNaN(maxPrice)) {
            includeAllSteps();
            return;
          }

          var step, orderedSteps = getStepsOrderedByPrio();
          for(step of orderedSteps) {
            remainingPrice -= step.price;
            changeStepInclusion(getStepCell(step.name), remainingPrice >= 0);
          }
        }

        $('#offer-table .step-name').click(function() {
          changeStepInclusion($(this), !steps[$(this).data('step')]['included']);
        });

        $('#offer-table select').change(function() {
          changeStepPriority($(this).data('step'), $(this).children('option:selected').text());
        });

        $('#max-price-input').change(function() {
          updateMaxPrice(parseFloat($(this).val()));
        });

        $('#max-price-input').focusout(function() {
          updateMaxPrice(parseFloat($(this).val()));
        });

        // Init forms
        $('#max-price-input').val('');
        $.each(steps, function(name, step) {
          $('#offer-table select[data-step="' + name + '"]').val(step.priority).attr('selected', 'selected');
        });

        // Tooltips
        $('[data-toggle="tooltip"]').tooltip('show');
        $('.tooltip').hover(function() {
          $(this).prev().tooltip('hide');
        });
      });
    </script>

</body>
</html>
